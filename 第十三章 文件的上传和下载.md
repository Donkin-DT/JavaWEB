###### ç¬¬åä¸‰ç«  æ–‡ä»¶çš„ä¸Šä¼ å’Œä¸‹è½½

```java
1.æ–‡ä»¶çš„ä¸Šä¼ 
    æ–‡ä»¶çš„ä¸Šä¼ å³å°†æœ¬åœ°æ–‡ä»¶ä¸Šä¼ åˆ°è¿œç¨‹æœåŠ¡å™¨ä¸­
    æ–‡ä»¶çš„ä¸Šä¼ æ˜¯ä»¥æµçš„å½¢å¼ä¸Šä¼ åˆ°æœåŠ¡å™¨
    æ–‡ä»¶ä¸Šä¼ çš„è¡¨å•çš„è¦æ±‚ï¼š ğŸ˜€
        1ï¼‰formè¡¨å•çš„methodå±æ€§å€¼ä¸ºpostï¼Œå³å¿…é¡»è¦æ˜¯ä¸€ä¸ªPOSTè¯·æ±‚
        2ï¼‰ä¸Šä¼ æ–‡ä»¶çš„è¡¨å•é¡¹çš„inputä¸­çš„typeå±æ€§å€¼ä¸ºfile
        3ï¼‰formè¡¨å•çš„enctypeå±æ€§å€¼å¿…é¡»ä¸ºmultipart/form-data
        enctypeçš„å€¼ä¸ºapplication/x-www-form-urlencodedæ—¶ï¼Œåœ¨æäº¤è¡¨å•ä¹‹å‰ä¼šå¯¹è¡¨å•ä¸­çš„å­—ç¬¦è¿›è¡ŒURLç¼–ç 
        enctypeçš„å€¼ä¸ºmultipart/form-dataæ—¶ï¼Œå„ä¸ªè¡¨å•é¡¹ä¼šä»¥ä¸€ä¸ªå¤šéƒ¨ä»¶çš„å½¢å¼æäº¤åˆ°æœåŠ¡å™¨ï¼Œä¸€ä¸ªè¡¨å•é¡¹å°±æ˜¯ä¸€ä¸ªå¤šéƒ¨ä»¶ï¼Œå„ä¸ªå¤šéƒ¨ä»¶ä¹‹é—´ä½¿ç”¨ç±»ä¼¼-----------------------------7e22f11090b20è¿™æ ·çš„åˆ†éš”ç¬¦åˆ†éš”
        
	FileUpload
	FileUploadæ˜¯Apacheç»™æˆ‘ä»¬æä¾›çš„ä¸“é—¨ç”¨æ¥è¿›è¡Œæ–‡ä»¶ä¸Šä¼ å’Œä¸‹è½½çš„å·¥å…·ï¼Œä½¿ç”¨å®ƒéœ€è¦å¯¼å…¥ä»¥ä¸‹ä¸¤ä¸ªjaråŒ…
            commons-fileupload-1.3.1.jar
            commons-io-2.5.jar
            
    æ ¸å¿ƒç±»å’Œæ¥å£
    	DiskFileItemFactory
    åˆ›å»ºå·¥å‚ç±»å®ä¾‹
    	ServletFileUpload
    åˆ›å»ºè§£æå™¨ç±»å®ä¾‹
    	FileItem
    è§£æå™¨è§£æè¯·æ±‚ä¹‹åï¼Œä¸€ä¸ªä¸ªçš„è¡¨å•é¡¹éƒ½è½¬æ¢ä¸ºäº†FileItemå¯¹è±¡
    
	å…·ä½“å®ç°
	//1.åˆ›å»ºå·¥å‚ç±»å®ä¾‹
        DiskFileItemFactory factory = new DiskFileItemFactory();
        //2.åˆ›å»ºè§£æå™¨ç±»å®ä¾‹
        ServletFileUpload fileUpload = new ServletFileUpload(factory);
        //å¯¹å•ä¸ªæ–‡ä»¶çš„å¤§å°è¿›è¡Œé™åˆ¶
        fileUpload.setFileSizeMax(7*1024);
        //å¯¹æ€»æ–‡ä»¶çš„å¤§å°è¿›è¡Œé™åˆ¶
        fileUpload.setSizeMax(20*1024);
        //è·å–IPåœ°å€
        String remoteAddr = request.getRemoteAddr();
        System.out.println(remoteAddr);
        try {
            //3.è§£æè¯·æ±‚å¾—åˆ°FileItemå¯¹è±¡
            List<FileItem> fileItems = fileUpload.parseRequest(request);
            //4.éå†å¾—åˆ°æ¯ä¸€ä¸ªFileItemå¯¹è±¡
            for (FileItem fileItem : fileItems) {
                /*
                 * 7ä¸ªæ ¸å¿ƒæ–¹æ³•ï¼š
                 *
                 *  isFormField()ï¼šåˆ¤æ–­æ˜¯å¦æ˜¯ä¸€ä¸ªæ™®é€šè¡¨å•é¡¹
                 *  getString(String encoding)ï¼šè·å–æ–‡æœ¬æ¡†ä¸­è¾“å…¥çš„å†…å®¹ï¼Œè¯¥æ–¹æ³•ä¸­å¯ä»¥ä¼ å…¥ä¸€ä¸ªå­—ç¬¦é›†
                 *  getFieldName()ï¼šè·å–è¡¨å•é¡¹ä¸­çš„nameå±æ€§å€¼
                 *
                 *  getContentType()ï¼šè·å–æ–‡ä»¶çš„ç±»å‹ï¼Œæ˜¯ä¸€ä¸ªMIMEå€¼
                 *  getName()ï¼šè·å–æ–‡ä»¶å
                 *  getSize()ï¼šè·å–æ–‡ä»¶çš„å¤§å°ï¼Œå•ä½æ˜¯å­—èŠ‚
                 *  write(File file)ï¼šå‘æœåŠ¡å™¨ä¸­å†™å…¥æ–‡ä»¶
                 */
                boolean formField = fileItem.isFormField();
                if(formField) {
                    //æ˜¯ä¸€ä¸ªæ™®é€šè¡¨å•é¡¹
                    //è·å–ç”¨æˆ·è¾“å…¥çš„å†…å®¹
                    String username = fileItem.getString("UTF-8");
                    System.out.println("ç”¨æˆ·è¾“å…¥çš„ç”¨æˆ·åæ˜¯ï¼š"+username);
                    //è·å–è¡¨å•é¡¹çš„nameå±æ€§å€¼
                    String fieldName = fileItem.getFieldName();
                    System.out.println("æ–‡æœ¬æ¡† çš„nameå±æ€§å€¼æ˜¯ï¼š"+fieldName);
                }else {
                    //æ˜¯ä¸Šä¼ æ–‡ä»¶çš„è¡¨å•é¡¹
                    //è·å–æ–‡ä»¶å
                    String name = fileItem.getName();
                    //å¯¹äºIEæµè§ˆå™¨ï¼Œè·å–çš„æ–‡ä»¶åå¸¦ç›˜ç¬¦ï¼Œæ­¤æ—¶æˆ‘ä»¬éœ€è¦å°†æ–‡ä»¶åä¹‹å‰çš„éƒ¨åˆ†æˆªå–
                    name = name.substring(name.lastIndexOf("\\")+1);
                    //è·å–æ–‡ä»¶çš„ç±»å‹
                    String contentType = fileItem.getContentType();
                    //è·å–æ–‡ä»¶çš„å¤§å°
                    long size = fileItem.getSize();
                    System.out.println("æ–‡ä»¶åæ˜¯ï¼š"+name);
                    System.out.println("æ–‡ä»¶çš„ç±»å‹æ˜¯ï¼š"+contentType);
                    System.out.println("æ–‡ä»¶çš„å¤§å°æ˜¯ï¼š"+size+"ä¸ªå­—èŠ‚");
                    //å°†æ–‡ä»¶æš‚æ—¶å…ˆå†™åˆ°Gç›˜çš„æ ¹ç›®å½•
				  //fileItem.write(new File("G:/"+name));
                    //éœ€æ±‚ï¼šå°†æ–‡ä»¶ä¸Šä¼ åˆ°æœåŠ¡å™¨çš„uploadç›®å½•ä¸­
                    //è·å–ServletContextå¯¹è±¡
                    ServletContext servletContext = getServletContext();
                    //è·å–æœåŠ¡å™¨ç«¯uploadç›®å½•çš„çœŸå®è·¯å¾„
                    String realPath = servletContext.getRealPath("/upload");
				  //System.out.println(realPath);
                    //åˆ¤æ–­æœåŠ¡å™¨ä¸­æ˜¯å¦æœ‰uploadç›®å½•ï¼Œå¦‚æœæ²¡æœ‰è®©å®ƒè‡ªåŠ¨åˆ›å»º
                    File file = new File(realPath);
                    if(!file.exists()) {
                        //è‡ªåŠ¨åˆ›å»º
                        file.mkdirs();
                    }
                    //é€šè¿‡UUIDéšæœºç”Ÿæˆä¸€ä¸ªå­—ç¬¦ä¸²ä½œä¸ºä¸Šä¼ æ–‡ä»¶çš„å‰ç¼€
                    String prefix = UUID.randomUUID().toString().replace("-", "");
                    //å°†æ–‡ä»¶ä¸Šä¼ uploadç›®å½•ä¸­
                    fileItem.write(new File(realPath+"/"+prefix+"_"+name));
                }
            }
            //é‡å®šå‘åˆ°ä¸Šä¼ æˆåŠŸé¡µé¢
            response.sendRedirect(request.getContextPath()+"/success.jsp");
        }catch (FileSizeLimitExceededException e) {
            e.printStackTrace();
            //è®¾ç½®ä¸€ä¸ªæç¤ºä¿¡æ¯å¹¶æ”¾åˆ°requeståŸŸä¸­ï¼Œç„¶åè½¬å‘åˆ°é¦–é¡µ
            request.setAttribute("msg", "å•ä¸ªæ–‡ä»¶çš„å¤§å°ä¸èƒ½è¶…è¿‡6KB!");
            request.getRequestDispatcher("/index.jsp").forward(request, response);
        }catch (SizeLimitExceededException e) {
            e.printStackTrace();
            //è®¾ç½®ä¸€ä¸ªæç¤ºä¿¡æ¯å¹¶æ”¾åˆ°requeståŸŸä¸­ï¼Œç„¶åè½¬å‘åˆ°é¦–é¡µ
            request.setAttribute("msg", "æ€»æ–‡ä»¶çš„å¤§å°ä¸èƒ½è¶…è¿‡20KB!");
            request.getRequestDispatcher("/index.jsp").forward(request, response);
        }catch (Exception e) {
            e.printStackTrace();
        }

2.æ–‡ä»¶çš„ä¸‹è½½
    æ–‡ä»¶çš„ä¸‹è½½å³å°†è¿œç¨‹æœåŠ¡å™¨ä¸­çš„æ–‡ä»¶ä¸‹è½½åˆ°æœ¬åœ°
    æ–‡ä»¶çš„ä¸‹è½½åªéœ€è¦å°†æ–‡ä»¶çš„åœ°å€è®¾ç½®åˆ°è¶…é“¾æ¥ä¸­ï¼Œç‚¹å‡»è¶…é“¾æ¥å³å¯ä¸‹è½½ï¼Œä½†æ˜¯å¦‚æœæµè§ˆå™¨æ”¯æŒè¯¥æ–‡ä»¶çš„æ ¼å¼å°†ç›´æ¥æ‰“å¼€ä¸å†ä¸‹è½½ï¼Œè€Œä¸”é€šè¿‡è¶…é“¾æ¥è¿™ç§æ–¹å¼ä¸‹è½½ä¸èƒ½è®¾ç½®è®¿é—®çš„æƒé™ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å°†ä¸‹è½½çš„èµ„æºæ”¾åˆ°WEB-INFç›®å½•ä¸‹ï¼Œé€šè¿‡è®¿é—®Servletå®ç°ä¸‹è½½
	å…·ä½“å®ç°	
        // è·å–ServletContextå¯¹è±¡
        ServletContext servletContext = getServletContext();
        // è·å–è¦ä¸‹è½½çš„èµ„æºçš„çœŸå®è·¯å¾„
        String realPath = servletContext.getRealPath("/WEB-INF/download/boy.mp3");
        // è®¾ç½®è¦ä¸‹è½½çš„æ–‡ä»¶çš„æ–‡ä»¶å
        String fileName = "ç”·å­©.mp3";
        String header = request.getHeader("User-Agent");
        // åˆ¤æ–­æ˜¯å¦ä½¿ç”¨çš„æ˜¯ç«ç‹æµè§ˆå™¨
        if (header.contains("Firefox")) {
            // å¯¹åº”ç«ç‹æµè§ˆå™¨ï¼Œä¸­æ–‡çš„æ–‡ä»¶åéœ€è¦è¿›è¡ŒBASE64ç¼–ç 
            fileName = "=?utf-8?b?" + new BASE64Encoder().encode(fileName.getBytes()) + "?=";
        } else {
            // å¯¹äºä¸­æ–‡çš„æ–‡ä»¶åéœ€è¦è¿›è¡ŒURLç¼–ç 
            fileName = URLEncoder.encode(fileName, "UTF-8");
        }
        // 1.åˆ›å»ºä¸€ä¸ªè¾“å…¥æµ
        InputStream is = new FileInputStream(realPath);
        // 2.è®¾ç½®ä¸¤ä¸ªå“åº”å¤´
        // 1ï¼‰è®¾ç½®è¦ä¸‹è½½çš„æ–‡ä»¶çš„ç±»å‹ï¼Œæ˜¯ä¸€ä¸ªMIMEå€¼
        // è·å–è¦ä¸‹è½½çš„æ–‡ä»¶çš„MIMEå€¼
        String mimeType = servletContext.getMimeType(realPath);
        // System.out.println(mimeType);
        // æ–¹å¼ä¸€ï¼š
        response.setContentType(mimeType);
        // æ–¹å¼äºŒï¼š
        // response.setHeader("Content-Type", mimeType);
        // 2ï¼‰è®¾ç½®è®©æµè§ˆå™¨å¦‚æœå¤„ç†è¯¥æ–‡ä»¶
        response.setHeader("Content-Disposition", "attachment;filename=" + fileName);
        // 3.å°†æµè¾“å‡ºåˆ°æµè§ˆå™¨
        // è·å–è¾“å‡ºæµ
        ServletOutputStream os = response.getOutputStream();
        IOUtils.copy(is, os);
        // å…³é—­æµ
        is.close();
```

